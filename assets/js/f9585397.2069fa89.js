"use strict";(self.webpackChunkcbl_ionic=self.webpackChunkcbl_ionic||[]).push([[5967],{673:(e,n,t)=>{t.r(n),t.d(n,{assets:()=>c,contentTitle:()=>a,default:()=>h,frontMatter:()=>o,metadata:()=>r,toc:()=>l});var i=t(4848),s=t(8453);const o={id:"remote-sync-gateway",sidebar_position:2},a="Remote Sync",r={id:"DataSync/remote-sync-gateway",title:"Remote Sync",description:"Description - Couchbase Lite for Ionic\u2009\u2014\u2009Synchronizing data changes between local and remote databases using Sync Gateway or Capella App Services",source:"@site/docs/DataSync/remote-sync-gateway.md",sourceDirName:"DataSync",slug:"/DataSync/remote-sync-gateway",permalink:"/DataSync/remote-sync-gateway",draft:!1,unlisted:!1,editUrl:"https://github.com/Couchbase-Ecosystem/cbl-ionic-docs/docs/DataSync/remote-sync-gateway.md",tags:[],version:"current",sidebarPosition:2,frontMatter:{id:"remote-sync-gateway",sidebar_position:2},sidebar:"tutorialSidebar",previous:{title:"Data Sync",permalink:"/category/data-sync"},next:{title:"Peer-to-Peer Sync",permalink:"/DataSync/peer-to-peer"}},c={},l=[{value:"Introduction",id:"introduction",level:2},{value:"Couchbase Capella Free Tier",id:"couchbase-capella-free-tier",level:2},{value:"Replication Concepts",id:"replication-concepts",level:2},{value:"Database",id:"database",level:4},{value:"Collection",id:"collection",level:4},{value:"Replication Protocol",id:"replication-protocol",level:2},{value:"Scheme",id:"scheme",level:3},{value:"Incompatibilities",id:"incompatibilities",level:4},{value:"Ordering",id:"ordering",level:3},{value:"Scopes and Collections",id:"scopes-and-collections",level:2},{value:"Default Collection",id:"default-collection",level:3},{value:"Sync Couchbase Lite database with the default collection on Sync Gateway",id:"sync-couchbase-lite-database-with-the-default-collection-on-sync-gateway",level:4},{value:"Sync Couchbase Lite default collection with default collection on Sync Gateway",id:"sync-couchbase-lite-default-collection-with-default-collection-on-sync-gateway",level:4},{value:"User-Defined Collections",id:"user-defined-collections",level:3},{value:"Syncing scope with user-defined collections.",id:"syncing-scope-with-user-defined-collections",level:4},{value:"Syncing scope with user-defined collections. Couchbase Lite has more collections than the Sync Gateway configuration (with collection filters)",id:"syncing-scope-with-user-defined-collections-couchbase-lite-has-more-collections-than-the-sync-gateway-configuration-with-collection-filters",level:4},{value:"Configuration Summary",id:"configuration-summary",level:2},{value:"Example 1. Replication configuration and initialization",id:"example-1-replication-configuration-and-initialization",level:4},{value:"Configure",id:"configure",level:2},{value:"In this section",id:"in-this-section",level:5},{value:"Configure Target",id:"configure-target",level:3},{value:"Example 2. Add Target to Configuration",id:"example-2-add-target-to-configuration",level:4},{value:"Sync Mode",id:"sync-mode",level:3},{value:"Example 4. Configure replicator type and mode",id:"example-4-configure-replicator-type-and-mode",level:4},{value:"Retry Configuration",id:"retry-configuration",level:3},{value:"Table 1. Replication Retry Configuration Properties",id:"table-1-replication-retry-configuration-properties",level:4},{value:"Example 5. Configuring Replication Retries",id:"example-5-configuring-replication-retries",level:4},{value:"User Authorization in Sync Gateway",id:"user-authorization-in-sync-gateway",level:3},{value:"Example 6. Enable Authorization",id:"example-6-enable-authorization",level:4},{value:"Server Authentication",id:"server-authentication",level:3},{value:"Example 7. Set Server TLS security",id:"example-7-set-server-tls-security",level:4},{value:"CA Cert",id:"ca-cert",level:5},{value:"Self Signed Cert",id:"self-signed-cert",level:5},{value:"Client Authentication",id:"client-authentication",level:3},{value:"Basic Authentication",id:"basic-authentication",level:4},{value:"Example 8. Basic Authentication",id:"example-8-basic-authentication",level:4},{value:"Session Authentication",id:"session-authentication",level:4},{value:"Example 9. Session Authentication",id:"example-9-session-authentication",level:4},{value:"Custom Headers",id:"custom-headers",level:3},{value:"Example 10. Setting custom headers",id:"example-10-setting-custom-headers",level:4},{value:"Channels",id:"channels",level:3},{value:"Documents",id:"documents",level:3},{value:"Auto-purge on Channel Access Revocation",id:"auto-purge-on-channel-access-revocation",level:3},{value:"New outcome",id:"new-outcome",level:4},{value:"Prior outcome",id:"prior-outcome",level:4},{value:"Behaviour",id:"behaviour",level:4},{value:"Table 2. Behavior following access revocation",id:"table-2-behavior-following-access-revocation",level:4},{value:"Table 3. Behavior if access is regained",id:"table-3-behavior-if-access-is-regained",level:4},{value:"Config",id:"config",level:4},{value:"Example 11. Setting auto-purge",id:"example-11-setting-auto-purge",level:4},{value:"Delta Sync",id:"delta-sync",level:3},{value:"Initialize",id:"initialize",level:2},{value:"In this section",id:"in-this-section-1",level:5},{value:"Start Replicator",id:"start-replicator",level:3},{value:"Example 12. Initialize and run replicator",id:"example-12-initialize-and-run-replicator",level:4},{value:"Checkpoint Starts",id:"checkpoint-starts",level:3},{value:"Example 13. Resetting checkpoints",id:"example-13-resetting-checkpoints",level:4},{value:"Monitor",id:"monitor",level:2},{value:"In this section",id:"in-this-section-2",level:5},{value:"Change Listeners",id:"change-listeners",level:3},{value:"Replicator Status",id:"replicator-status",level:3},{value:"Example 14. Monitor replication",id:"example-14-monitor-replication",level:4},{value:"Replication States",id:"replication-states",level:3},{value:"Table 5. Replicator activity levels",id:"table-5-replicator-activity-levels",level:4},{value:"Replication Status and App Life Cycle",id:"replication-status-and-app-life-cycle",level:3},{value:"Monitor Document Changes",id:"monitor-document-changes",level:3},{value:"Example 15. Register a document listener",id:"example-15-register-a-document-listener",level:4},{value:"Example 16. Stop document listener",id:"example-16-stop-document-listener",level:4},{value:"Document Access Removal Behavior",id:"document-access-removal-behavior",level:3},{value:"Documents Pending Push",id:"documents-pending-push",level:2},{value:"Example 17. Use Pending Document ID API",id:"example-17-use-pending-document-id-api",level:4},{value:"Stop",id:"stop",level:2},{value:"Example 18. Stop replicator",id:"example-18-stop-replicator",level:4},{value:"Error Handling",id:"error-handling",level:2},{value:"Example 19. Monitoring for network errors",id:"example-19-monitoring-for-network-errors",level:4},{value:"Load Balancers",id:"load-balancers",level:2},{value:"Troubleshooting",id:"troubleshooting",level:2},{value:"Logs",id:"logs",level:3},{value:"Example 21. Set logging verbosity",id:"example-21-set-logging-verbosity",level:4},{value:"Authentication Errors",id:"authentication-errors",level:3},{value:"Example 22. Protocol Mismatch",id:"example-22-protocol-mismatch",level:4},{value:"Example 23. Certificate Mismatch or Not Found",id:"example-23-certificate-mismatch-or-not-found",level:4}];function d(e){const n={a:"a",admonition:"admonition",blockquote:"blockquote",code:"code",em:"em",h1:"h1",h2:"h2",h3:"h3",h4:"h4",h5:"h5",img:"img",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",table:"table",tbody:"tbody",td:"td",th:"th",thead:"thead",tr:"tr",ul:"ul",...(0,s.R)(),...e.components};return(0,i.jsxs)(i.Fragment,{children:[(0,i.jsx)(n.h1,{id:"remote-sync",children:"Remote Sync"}),"\n",(0,i.jsxs)(n.blockquote,{children:["\n",(0,i.jsxs)(n.p,{children:["Description - ",(0,i.jsx)(n.em,{children:"Couchbase Lite for Ionic\u2009\u2014\u2009Synchronizing data changes between local and remote databases using Sync Gateway or Capella App Services"})]}),"\n"]}),"\n",(0,i.jsx)(n.admonition,{type:"note",children:(0,i.jsx)(n.p,{children:"All code examples are indicative only. They demonstrate the basic concepts and approaches to using a feature. Use them as inspiration and adapt these examples to best practice when developing applications for your platform."})}),"\n",(0,i.jsx)(n.h2,{id:"introduction",children:"Introduction"}),"\n",(0,i.jsxs)(n.p,{children:["Couchbase Lite for Ionic provides API support for secure, bi-directional, synchronization of data changes between mobile applications and a central server database. It does so by using a ",(0,i.jsx)(n.em,{children:"replicator"})," to interact with Sync Gateway or Capella App Services."]}),"\n",(0,i.jsxs)(n.p,{children:["The ",(0,i.jsx)(n.em,{children:"replicator"})," is designed to manage replication of documents and-or document changes between a source and a target database. For example, between a local Couchbase Lite database and Capella App Services endpoint, which is ultimately mapped to a bucket in a Couchbase Capella Couchbase cluster instance in the cloud."]}),"\n",(0,i.jsx)(n.p,{children:"This page shows sample code and configuration examples covering the implementation of a replication using Sync Gateway or Capella App Services."}),"\n",(0,i.jsx)(n.p,{children:"Your application runs a replicator (also referred to here as a client), which will initiate connection with a Sync Gateway or Capella App Services endpoint (also referred to here as a server) and participate in the replication of database changes to bring both local and remote databases into sync."}),"\n",(0,i.jsx)(n.p,{children:"Subsequent sections provide additional details and examples for the main configuration options."}),"\n",(0,i.jsx)(n.h2,{id:"couchbase-capella-free-tier",children:"Couchbase Capella Free Tier"}),"\n",(0,i.jsx)(n.p,{children:"Couchbase Capella offers a free tier that allows you to get started with Couchbase Capella and Couchbase Capella App Services. The free tier includes a single node Capella cluster."}),"\n",(0,i.jsxs)(n.p,{children:["To get started with the free tier, see the documentation on ",(0,i.jsx)(n.a,{href:"https://docs.couchbase.com/cloud/get-started/create-account.html",children:"Couchbase Capella Free Tier"}),".  For new developers to the platform, Couchbase Capella free tier is the fastest way to get started trying out sync within your mobile application."]}),"\n",(0,i.jsx)(n.h2,{id:"replication-concepts",children:"Replication Concepts"}),"\n",(0,i.jsx)(n.p,{children:"Couchbase Lite allows for one or more databases for each application running on the mobile device. These databases can contain one or more scopes. Each scope can contain one or more collections."}),"\n",(0,i.jsxs)(n.p,{children:["To learn about Scopes and Collections, see ",(0,i.jsx)(n.a,{href:"/databases",children:"Databases"}),"."]}),"\n",(0,i.jsx)(n.p,{children:"You can set up a replication scheme across these data levels:"}),"\n",(0,i.jsx)(n.h4,{id:"database",children:"Database"}),"\n",(0,i.jsxs)(n.p,{children:["The ",(0,i.jsx)(n.code,{children:"_default"})," collection is synced."]}),"\n",(0,i.jsx)(n.h4,{id:"collection",children:"Collection"}),"\n",(0,i.jsx)(n.p,{children:"A specific collection or a set of collections is synced."}),"\n",(0,i.jsx)(n.p,{children:"As part of the syncing setup, the replicator has to map the Couchbase Lite database collections to the configuration on the remote server."}),"\n",(0,i.jsx)(n.h2,{id:"replication-protocol",children:"Replication Protocol"}),"\n",(0,i.jsx)(n.h3,{id:"scheme",children:"Scheme"}),"\n",(0,i.jsxs)(n.p,{children:["Couchbase Mobile uses a replication protocol based on WebSockets for replication. To use this protocol the replication URL should specify WebSockets as the URL scheme (see the ",(0,i.jsx)(n.a,{href:"#configure-target",children:"Configure Target"})," section below)."]}),"\n",(0,i.jsx)(n.h4,{id:"incompatibilities",children:"Incompatibilities"}),"\n",(0,i.jsxs)(n.p,{children:["Couchbase Lite\u2019s replication protocol is incompatible with CouchDB-based databases. And since Couchbase Lite 2.x+ only supports the new protocol, you will need to run a version of Sync Gateway that supports it\u2009\u2014\u2009see: ",(0,i.jsx)(n.a,{href:"/ProductNotes/compatibility",children:"Compatibility"}),"."]}),"\n",(0,i.jsx)(n.h3,{id:"ordering",children:"Ordering"}),"\n",(0,i.jsx)(n.p,{children:"To optimize for speed, the replication protocol doesn\u2019t guarantee that documents will be received in a particular order. So we don\u2019t recommend to rely on that when using the replication or database change listeners for example."}),"\n",(0,i.jsx)(n.h2,{id:"scopes-and-collections",children:"Scopes and Collections"}),"\n",(0,i.jsx)(n.p,{children:"Scopes and Collections allow you to organize your documents in Couchbase Lite."}),"\n",(0,i.jsx)(n.p,{children:"When syncing, you can configure the collections to be synced."}),"\n",(0,i.jsx)(n.p,{children:"The collections specified in the Couchbase Lite replicator setup must exist (both scope and collection name must be identical) on the Server side and configured to sync, otherwise starting the Couchbase Lite replicator will result in an error."}),"\n",(0,i.jsx)(n.p,{children:"During replication:"}),"\n",(0,i.jsxs)(n.ol,{children:["\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsx)(n.p,{children:"If the server config is updated to remove a collection that is being synced, the client replicator will be offline and will be stopped after the first retry. An error will be reported."}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsx)(n.p,{children:"If the server config is updated to add a collection to a scope that is being synchronized, the replication will ignore the collection. The added collection will not automatically sync until the Couchbase Lite replicator\u2019s configuration is updated."}),"\n"]}),"\n"]}),"\n",(0,i.jsx)(n.h3,{id:"default-collection",children:"Default Collection"}),"\n",(0,i.jsx)(n.p,{children:"When upgrading Couchbase Lite to >= 3.1, the existing documents in the database will be automatically migrated to the default collection."}),"\n",(0,i.jsx)(n.p,{children:"For backward compatibility with the code prior to >= 3.1, when you set up the replicator with the database, the default collection will be set up to sync with the default collection on the server."}),"\n",(0,i.jsx)(n.h4,{id:"sync-couchbase-lite-database-with-the-default-collection-on-sync-gateway",children:"Sync Couchbase Lite database with the default collection on Sync Gateway"}),"\n",(0,i.jsx)("div",{align:"center",children:(0,i.jsx)(n.p,{children:(0,i.jsx)(n.img,{alt:"Cbl Replication Scopes Collections 1",src:t(7943).A+"",width:"898",height:"308"})})}),"\n",(0,i.jsx)(n.h4,{id:"sync-couchbase-lite-default-collection-with-default-collection-on-sync-gateway",children:"Sync Couchbase Lite default collection with default collection on Sync Gateway"}),"\n",(0,i.jsx)("div",{align:"center",children:(0,i.jsx)(n.p,{children:(0,i.jsx)(n.img,{alt:"Cbl Replication Scopes Collections 2",src:t(7308).A+"",width:"870",height:"429"})})}),"\n",(0,i.jsx)(n.h3,{id:"user-defined-collections",children:"User-Defined Collections"}),"\n",(0,i.jsx)(n.p,{children:"The user-defined collections specified in the Couchbase Lite replicator setup must exist (and be identical) on the Sync Gateway side to sync."}),"\n",(0,i.jsx)(n.h4,{id:"syncing-scope-with-user-defined-collections",children:"Syncing scope with user-defined collections."}),"\n",(0,i.jsx)("div",{align:"center",children:(0,i.jsx)(n.p,{children:(0,i.jsx)(n.img,{alt:"Cbl Replication Scopes Collections 3",src:t(6725).A+"",width:"866",height:"421"})})}),"\n",(0,i.jsx)(n.h4,{id:"syncing-scope-with-user-defined-collections-couchbase-lite-has-more-collections-than-the-sync-gateway-configuration-with-collection-filters",children:"Syncing scope with user-defined collections. Couchbase Lite has more collections than the Sync Gateway configuration (with collection filters)"}),"\n",(0,i.jsx)("div",{align:"center",children:(0,i.jsx)(n.p,{children:(0,i.jsx)(n.img,{alt:"Cbl Replication Scopes Collections 4",src:t(2058).A+"",width:"902",height:"436"})})}),"\n",(0,i.jsx)(n.h2,{id:"configuration-summary",children:"Configuration Summary"}),"\n",(0,i.jsxs)(n.p,{children:["You should configure and initialize a replicator for each Couchbase Lite database instance you want to sync. ",(0,i.jsx)(n.a,{href:"#example-1-replication-configuration-and-initialization",children:"Example 1"})," shows the configuration and initialization process."]}),"\n",(0,i.jsx)(n.admonition,{type:"note",children:(0,i.jsxs)(n.p,{children:["You need Couchbase Lite 3.1+ and Sync Gateway 3.1+ or Capella App Services to use ",(0,i.jsx)(n.code,{children:"custom"})," Scopes and Collections.\nIf you\u2019re using a Sync Gateway release that is older than version 3.1, you won\u2019t be able to access ",(0,i.jsx)(n.code,{children:"custom"})," Scopes and Collections. To use Couchbase Lite 3.1+ with these older versions, you can use the ",(0,i.jsx)(n.code,{children:"default"})," Collection as a backup option."]})}),"\n",(0,i.jsx)(n.h4,{id:"example-1-replication-configuration-and-initialization",children:"Example 1. Replication configuration and initialization"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-typescript",children:"//assumes you are running sync gateway locally, if you are \n //running app services, replace enpoint with proper url and creditentials\n const target = new URLEndpoint('ws://localhost:4984/projects');\n const auth = new BasicAuthenticator('demo@example.com', 'P@ssw0rd12');\n const config = new ReplicatorConfiguration(target);\n config.addCollection(collectionName);\n config.setAuthenticator(auth);\n\n const replicator = await Replicator.create(config);\n\n //listen to the replicator change events\n const token = await replicator.addChangeListener((change) => {\n\t//check to see if there was an error\n   \tconst error = change.status.getError();\n  \tif (error !== undefined) {\n\t\t//do something with the error\n   \t}\n   \t//get the status of the replicator using ReplicatorActivityLevel enum\n  \tif (change.status.getActivityLevel() ===  ReplicatorActivityLevel.IDLE) {\n   \t\t//do something because the replicator is now IDLE\n   \t}\n });\n\n // start the replicator without making a new checkpoint\n await replicator.start(false);\n\n //remember you must clean up the replicator when done with it by \n //doing the following lines\n\n //await replicator.removeChangeListener(token);\n //await replicator.stop();\n"})}),"\n",(0,i.jsx)(n.h2,{id:"configure",children:"Configure"}),"\n",(0,i.jsx)(n.h5,{id:"in-this-section",children:"In this section"}),"\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.a,{href:"#configure-target",children:"Configure Target"})," | ",(0,i.jsx)(n.a,{href:"#sync-mode",children:"Sync Mode"})," | ",(0,i.jsx)(n.a,{href:"#retry-configuration",children:"Retry Configuration"})," | ",(0,i.jsx)(n.a,{href:"#user-authorization",children:"User Authorization"})," | ",(0,i.jsx)(n.a,{href:"#server-authentication",children:"Server Authentication"})," | ",(0,i.jsx)(n.a,{href:"#client-authentication",children:"Client Authentication"})," | ",(0,i.jsx)(n.a,{href:"#monitor-document-changes",children:"Monitor Document Changes"})," | ",(0,i.jsx)(n.a,{href:"#custom-headers",children:"Custom Headers"})," | ",(0,i.jsx)(n.a,{href:"#checkpoint-starts",children:"Checkpoint Starts"})," | ",(0,i.jsx)(n.a,{href:"#channels",children:"Channels"})," | ",(0,i.jsx)(n.a,{href:"#auto-purge-on-channel-access-revocation",children:"Auto-purge on Channel Access Revocation"})," | ",(0,i.jsx)(n.a,{href:"#delta-sync",children:"Delta Sync"})]}),"\n",(0,i.jsx)(n.h3,{id:"configure-target",children:"Configure Target"}),"\n",(0,i.jsx)(n.p,{children:"Use the Initialize and define the replication configuration with local and remote database locations using the ReplicatorConfiguration object."}),"\n",(0,i.jsx)(n.p,{children:"The constructor provides:"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:"the name of the local database to be sync\u2019d"}),"\n",(0,i.jsx)(n.li,{children:"the server\u2019s URL (including the port number and the name of the remote database to sync with)"}),"\n"]}),"\n",(0,i.jsxs)(n.p,{children:["It is expected that the app will identify the IP address and URL and append the remote database name to the URL endpoint, producing for example: ",(0,i.jsx)(n.code,{children:"wss://10.0.2.2:4984/travel-sample"}),"\nThe URL scheme for web socket URLs uses ",(0,i.jsx)(n.code,{children:"ws:"})," (non-TLS) or ",(0,i.jsx)(n.code,{children:"wss:"})," (SSL/TLS) prefixes."]}),"\n",(0,i.jsx)(n.h4,{id:"example-2-add-target-to-configuration",children:"Example 2. Add Target to Configuration"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-typescript",children:"// Define the target URL for the replication endpoint\nconst targetURL = 'wss://10.1.1.12:4984/travel-sample';\n\n// Initialize the URLEndpoint with the target URL\nconst targetEndpoint = new URLEndpoint(targetURL);\n\n// Create the ReplicatorConfiguration with the target endpoint\nconst config = new ReplicatorConfiguration(targetEndpoint);\n\n// Add the already initialised collection to the replicator configuration\nconfig.addCollection(collectionName);\n"})}),"\n",(0,i.jsx)(n.admonition,{type:"note",children:(0,i.jsxs)(n.p,{children:["Note use of the scheme prefix (",(0,i.jsx)(n.code,{children:"wss://"})," to ensure TLS encryption\u2009\u2014\u2009strongly recommended in production\u2009\u2014\u2009or ",(0,i.jsx)(n.code,{children:"ws://"}),")"]})}),"\n",(0,i.jsx)(n.h3,{id:"sync-mode",children:"Sync Mode"}),"\n",(0,i.jsx)(n.p,{children:"Here we define the direction and type of replication we want to initiate."}),"\n",(0,i.jsxs)(n.p,{children:["We use ",(0,i.jsx)(n.code,{children:"ReplicatorConfiguration"})," class\u2019s ",(0,i.jsx)(n.code,{children:"replicatorType"})," and ",(0,i.jsx)(n.code,{children:"continuous"})," parameters, to tell the replicator:"]}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:["The type (or direction) of the replication: ",(0,i.jsx)(n.code,{children:"PUSH_AND_PULL"}),"; ",(0,i.jsx)(n.code,{children:"PULL"}),"; ",(0,i.jsx)(n.code,{children:"PUSH"})]}),"\n",(0,i.jsxs)(n.li,{children:["The replication mode, that is either of:","\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:["Continuous - remaining active indefinitely to replicate changed documents (",(0,i.jsx)(n.code,{children:"continuous=true"}),")."]}),"\n",(0,i.jsxs)(n.li,{children:["Ad-hoc - a one-shot replication of changed documents (",(0,i.jsx)(n.code,{children:"continuous=false"}),")"]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,i.jsx)(n.h4,{id:"example-4-configure-replicator-type-and-mode",children:"Example 4. Configure replicator type and mode"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-typescript",children:"config.replicatorType = ReplicatorType.PUSH_AND_PULL;\n\n// Configure Sync Mode\nconfig.continuous = true\n"})}),"\n",(0,i.jsxs)(n.admonition,{type:"tip",children:[(0,i.jsxs)(n.p,{children:["Unless there is a solid use-case not to, always initiate a single ",(0,i.jsx)(n.code,{children:"PUSH_AND_PULL"})," replication rather than identical separate ",(0,i.jsx)(n.code,{children:"PUSH"})," and ",(0,i.jsx)(n.code,{children:"PULL"})," replications."]}),(0,i.jsxs)(n.p,{children:["This prevents the replications generating the same checkpoint ",(0,i.jsx)(n.code,{children:"docID"})," resulting in multiple conflicts."]})]}),"\n",(0,i.jsx)(n.h3,{id:"retry-configuration",children:"Retry Configuration"}),"\n",(0,i.jsx)(n.p,{children:"Couchbase Lite for Ionic's replication retry logic assures a resilient connection."}),"\n",(0,i.jsx)(n.p,{children:"Couchbase Lite for Swift\u2019s replication retry logic assures a resilient connection."}),"\n",(0,i.jsx)(n.p,{children:"In the event it detects a transient error, the replicator will attempt to reconnect, stopping only when the connection is re-established, or the number of retries exceeds the retry limit (9 times for a single-shot replication and unlimited for a continuous replication)."}),"\n",(0,i.jsx)(n.p,{children:"On each retry the interval between attempts is increased exponentially (exponential backoff) up to the maximum wait time limit (5 minutes)."}),"\n",(0,i.jsxs)(n.p,{children:["The REST API provides configurable control over this replication retry logic using a set of configiurable properties\u2009\u2014\u2009see: ",(0,i.jsx)(n.a,{href:"#table-1-replication-retry-configuration-properties",children:"Table 1"}),"."]}),"\n",(0,i.jsx)(n.h4,{id:"table-1-replication-retry-configuration-properties",children:"Table 1. Replication Retry Configuration Properties"}),"\n",(0,i.jsxs)(n.table,{children:[(0,i.jsx)(n.thead,{children:(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.th,{children:"Property"}),(0,i.jsx)(n.th,{children:"Use cases"}),(0,i.jsx)(n.th,{children:"Description"})]})}),(0,i.jsxs)(n.tbody,{children:[(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"heartbeat()"})}),(0,i.jsxs)(n.td,{children:["Reduce to detect connection errors sooner ",(0,i.jsx)("br",{})," ",(0,i.jsx)("br",{})," Align to load-balancer or proxy ",(0,i.jsx)(n.code,{children:"keep-alive"})," interval - see Sync Gateway\u2019s topic ",(0,i.jsx)(n.a,{href:"https://docs.couchbase.com/sync-gateway/current/load-balancer.html#websocket-connection",children:"Load Balancer - Keep Alive"})]}),(0,i.jsxs)(n.td,{children:["The interval (in seconds) between the heartbeat pulses. ",(0,i.jsx)("br",{})," ",(0,i.jsx)("br",{})," Default: The replicator pings the Sync Gateway every 300 seconds."]})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"maxAttempts()"})}),(0,i.jsx)(n.td,{children:"Change this to limit or extend the number of retry attempts."}),(0,i.jsxs)(n.td,{children:["The maximum number of retry attempts. ",(0,i.jsx)("br",{})," ",(0,i.jsx)("br",{})," Set to zero (0) to use default values. ",(0,i.jsx)("br",{})," ",(0,i.jsx)("br",{})," Set to one (1) to prevent any retry attempt. ",(0,i.jsx)("br",{})," ",(0,i.jsx)("br",{})," The retry attempt count is reset when the replicator is able to connect and replicate. ",(0,i.jsx)("br",{})," ",(0,i.jsx)("br",{})," Default values are: ",(0,i.jsx)("br",{})," - Single-shot replication = 9 ",(0,i.jsx)("br",{})," - Continuous replication = maximum integer value. ",(0,i.jsx)("br",{})," ",(0,i.jsx)("br",{})," Negative values generate a Couchbase exception ",(0,i.jsx)(n.code,{children:"InvalidArgumentException"}),"."]})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"maxAttemptWaitTime()"})}),(0,i.jsx)(n.td,{children:"Change this to adjust the interval between retries."}),(0,i.jsxs)(n.td,{children:["The maximum interval between retry attempts. ",(0,i.jsx)("br",{})," ",(0,i.jsx)("br",{})," While you can configure the maximum permitted wait time, the replicator\u2019s exponential backoff algorithm calculates each individual interval which is not configurable. ",(0,i.jsx)("br",{})," ",(0,i.jsx)("br",{})," Default value: 300 seconds (5 minutes). ",(0,i.jsx)("br",{})," ",(0,i.jsx)("br",{})," Zero sets the maximum interval between retries to the default of 300 seconds. ",(0,i.jsx)("br",{})," ",(0,i.jsx)("br",{})," 300 sets the maximum interval between retries to the default of 300 seconds. ",(0,i.jsx)("br",{})," ",(0,i.jsx)("br",{})," A negative value generates a Couchbase exception, ",(0,i.jsx)(n.code,{children:"InvalidArgumentException"}),"."]})]})]})]}),"\n",(0,i.jsxs)(n.p,{children:["When necessary you can adjust any or all of those configurable values\u2009\u2014\u2009see: ",(0,i.jsx)(n.a,{href:"#example-5-configuring-replication-retries",children:"Example 5"})," for how to do this."]}),"\n",(0,i.jsx)(n.h4,{id:"example-5-configuring-replication-retries",children:"Example 5. Configuring Replication Retries"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-typescript",children:"// Create the target endpoint\nconst target = new URLEndpoint('ws://foo.couchbase.com/db');\n\n// Create the replicator configuration\nconst config = new ReplicatorConfiguration(target);\n\n// Add the collection to the replicator configuration\nconfig.addCollection(collection);\n\n// Set the replicator type\nconfig.setReplicatorType(ReplicatorType.PUSH_AND_PULL);\n\n// Set continuous replication\nconfig.setContinuous(true);\n\n// Set heartbeat interval (in seconds)\nconfig.setHeartbeat(150);\n\n// Set the maximum number of retry attempts\nconfig.setMaxAttempts(20);\n\n// Set the maximum wait time between retry attempts (in seconds)\nconfig.setMaxAttemptWaitTime(600);\n\n// Create the replicator with the configuration\nconst replicator = await Replicator.create(config);\n"})}),"\n",(0,i.jsxs)(n.ol,{children:["\n",(0,i.jsxs)(n.li,{children:["Here we use ",(0,i.jsx)(n.code,{children:"setHeartbeat()"})," to set the required interval (in seconds) between the heartbeat pulses"]}),"\n",(0,i.jsxs)(n.li,{children:["Here we use ",(0,i.jsx)(n.code,{children:"setMaxAttempts()"})," to set the required number of retry attempts"]}),"\n",(0,i.jsxs)(n.li,{children:["Here we use ",(0,i.jsx)(n.code,{children:"setMaxAttemptWaitTime()"})," to set the required interval between retry attempts."]}),"\n"]}),"\n",(0,i.jsx)(n.h3,{id:"user-authorization-in-sync-gateway",children:"User Authorization in Sync Gateway"}),"\n",(0,i.jsx)(n.p,{children:"By default, Sync Gateway does not enable user authorization. This makes it easier to get up and running with synchronization."}),"\n",(0,i.jsxs)(n.p,{children:["You can enable authorization in the sync gateway configuration file, as shown in ",(0,i.jsx)(n.a,{href:"#example-6-enable-authorization",children:"Example 6"}),"."]}),"\n",(0,i.jsx)(n.h4,{id:"example-6-enable-authorization",children:"Example 6. Enable Authorization"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-json",children:'{\n  "databases": {\n    "mydatabase": {\n      "users": {\n        "GUEST": {"disabled": true}\n      }\n    }\n  }\n}\n'})}),"\n",(0,i.jsxs)(n.p,{children:["To authorize with Sync Gateway, an associated user must first be created. Sync Gateway users can be created through the ",(0,i.jsx)(n.a,{href:"https://docs.couchbase.com/sync-gateway/current/rest-api-admin.html#/user/post__db___user_",children:(0,i.jsx)(n.code,{children:"POST /{tkn-db}/_user"})})," endpoint on the Admin REST API."]}),"\n",(0,i.jsx)(n.h3,{id:"server-authentication",children:"Server Authentication"}),"\n",(0,i.jsx)(n.p,{children:"Define the credentials your app (the client) is expecting to receive from the Sync Gateway or Capella App Services (the server) in order to ensure it is prepared to continue with the sync."}),"\n",(0,i.jsxs)(n.p,{children:["Note that the client cannot authenticate the server if TLS is turned off. When TLS is enabled (Sync Gateway\u2019s default) the client ",(0,i.jsx)(n.em,{children:"must"})," authenticate the server. If the server cannot provide acceptable credentials then the connection will fail."]}),"\n",(0,i.jsxs)(n.p,{children:["Use ",(0,i.jsx)(n.code,{children:"ReplicatorConfiguration"})," property ",(0,i.jsx)(n.code,{children:"acceptOnlySelfSignedServerCertificate"})," to tell the replicator how to verify server-supplied TLS server certificates."]}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:["If ",(0,i.jsx)(n.code,{children:"acceptOnlySelfSignedServerCertificate"})," is ",(0,i.jsx)(n.code,{children:"true"})," then any self-signed certificate is accepted. Certificates that are not self signed are rejected, no matter who signed them."]}),"\n",(0,i.jsxs)(n.li,{children:["If ",(0,i.jsx)(n.code,{children:"acceptOnlySelfSignedServerCertificate"})," is ",(0,i.jsx)(n.code,{children:"false"})," (default), the client validates the server\u2019s certificates against the system CA certificates. The server must supply a chain of certificates whose root is signed by one of the certificates in the system CA bundle."]}),"\n"]}),"\n",(0,i.jsx)(n.h4,{id:"example-7-set-server-tls-security",children:"Example 7. Set Server TLS security"}),"\n",(0,i.jsx)(n.h5,{id:"ca-cert",children:"CA Cert"}),"\n",(0,i.jsx)(n.p,{children:"Set the client to expect and accept only CA attested certificates."}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-typescript",children:"// Configure Server Security -- only accept CA Certs\nconfig.acceptOnlySelfSignedServerCertificate = false\n"})}),"\n",(0,i.jsx)(n.p,{children:"This is the default. Only certificate chains with roots signed by a trusted CA are allowed. Self signed certificates are not allowed."}),"\n",(0,i.jsx)(n.h5,{id:"self-signed-cert",children:"Self Signed Cert"}),"\n",(0,i.jsx)(n.p,{children:"Set the client to expect and accept only self-signed certificates"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-typescript",children:"// Configure Server Security -- only accept self-signed certs\nconfig.acceptOnlySelfSignedServerCertificate = true; \n"})}),"\n",(0,i.jsx)(n.p,{children:"Set this to true to accept any self signed cert. Any certificates that are not self-signed are rejected."}),"\n",(0,i.jsx)(n.p,{children:"This all assumes that you have configured the server to provide the appropriate SSL certificates, and have included the appropriate certificate in your app bundle."}),"\n",(0,i.jsx)(n.h3,{id:"client-authentication",children:"Client Authentication"}),"\n",(0,i.jsxs)(n.p,{children:["There are two ways to authenticate from a Couchbase Lite client: ",(0,i.jsx)(n.code,{children:"Basic Authentication"})," or ",(0,i.jsx)(n.code,{children:"Session Authentication"}),"."]}),"\n",(0,i.jsx)(n.h4,{id:"basic-authentication",children:"Basic Authentication"}),"\n",(0,i.jsxs)(n.p,{children:["You can provide a user name and password to the basic authenticator class method. Under the hood, the replicator will send the credentials in the first request to retrieve a ",(0,i.jsx)(n.code,{children:"SyncGatewaySession"})," cookie and use it for all subsequent requests during the replication. This is the recommended way of using basic authentication. ",(0,i.jsx)(n.a,{href:"#example-8-basic-authentication",children:"Example 8"})," shows how to initiate a one-shot replication as the user ",(0,i.jsx)(n.strong,{children:"username"})," with the password ",(0,i.jsx)(n.strong,{children:"password"}),"."]}),"\n",(0,i.jsx)(n.h4,{id:"example-8-basic-authentication",children:"Example 8. Basic Authentication"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-typescript",children:'const url = "ws://localhost:4984/mydatabase";\nconst target = new URLEndpoint(url);\nconst auth = new BasicAuthenticator("john", "pass"); \nconst config = new ReplicatorConfiguration(target);\n\n// Assuming collection is already defined and initialized\nconfig.addCollection(collectionName);\nconfig.setAuthenticator(auth);\n\nconst replicator = new Replicator(config);\nawait replicator.start();\n'})}),"\n",(0,i.jsx)(n.h4,{id:"session-authentication",children:"Session Authentication"}),"\n",(0,i.jsx)(n.p,{children:"Session authentication is another way to authenticate with Sync Gateway or Capella App Services."}),"\n",(0,i.jsxs)(n.p,{children:["A user session must first be created through the ",(0,i.jsx)(n.a,{href:"https://docs.couchbase.com/sync-gateway/current/rest-api.html#/session/post__db___session",children:(0,i.jsx)(n.code,{children:"POST /{tkn-db}/_session"})})," endpoint on the Public REST API."]}),"\n",(0,i.jsx)(n.p,{children:"The HTTP response contains a session ID which can then be used to authenticate as the user it was created for."}),"\n",(0,i.jsxs)(n.p,{children:["See ",(0,i.jsx)(n.a,{href:"#example-9-session-authentication",children:"Example 9"}),", which shows how to initiate a one-shot replication with the session ID returned from the ",(0,i.jsx)(n.code,{children:"POST /{tkn-db}/_session"})," endpoint."]}),"\n",(0,i.jsx)(n.h4,{id:"example-9-session-authentication",children:"Example 9. Session Authentication"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-typescript",children:"const url = new URL(\"ws://localhost:4984/mydatabase\");\nconst target = new URLEndpoint(url);\nconst config = new ReplicatorConfiguration(target);\nconst sessionID = 'your-session-id';\nconst cookieName = 'your-cookie-name';\n\n// Assuming collection is already defined and initialized\nconfig.addCollection(collectionName);\n\n// Here cookieName is optional, if not passed it will default to the default value\nconst sessionAuthenticator = new SessionAuthenticator(sessionID, cookieName);\nconfig.setAuthenticator(sessionAuthenticator);\n\nlet replicator = new Replicator(config);\nawait replicator.start();\n"})}),"\n",(0,i.jsx)(n.h3,{id:"custom-headers",children:"Custom Headers"}),"\n",(0,i.jsx)(n.p,{children:"Custom headers can be set on the configuration object. The replicator will then include those headers in every request."}),"\n",(0,i.jsxs)(n.p,{children:["This feature is useful in passing additional credentials, perhaps when an authentication or authorization step is being done by a proxy server (between Couchbase Lite and Sync Gateway)\u2009\u2014\u2009see ",(0,i.jsx)(n.a,{href:"#example-10-setting-custom-headers",children:"Example 10"}),"."]}),"\n",(0,i.jsx)(n.h4,{id:"example-10-setting-custom-headers",children:"Example 10. Setting custom headers"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-typescript",children:'const config = new ReplicatorConfiguration(target);\nconfig.addCollection(collection);\n\n// Setting headers\nconfig.setHeaders({ "CustomHeaderName": "Value" });\n'})}),"\n",(0,i.jsx)(n.h3,{id:"channels",children:"Channels"}),"\n",(0,i.jsx)(n.p,{children:"By default, Couchbase Lite gets all the channels to which the configured user account has access."}),"\n",(0,i.jsxs)(n.p,{children:["This behavior is suitable for most apps that rely on ",(0,i.jsx)(n.code,{children:"user authentication"})," and the ",(0,i.jsx)(n.code,{children:"sync function"})," to specify which data to pull for each user."]}),"\n",(0,i.jsx)(n.p,{children:"Optionally, it\u2019s also possible to specify a string array of channel names on Couchbase Lite\u2019s replicator configuration object by passing in a CollectionConfiguration object when adding in a collection."}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-typescript",children:"const config = new ReplicatorConfiguration(target);\nconst collectionConfig = new CollectionConfiguration();\ncollectionConfig.setChannels(['channel1', 'channel2']);\nconfig.addCollection(collection, collectionConfig);\n"})}),"\n",(0,i.jsx)(n.p,{children:"In this case, the replication from the server will only pull documents tagged with those channels."}),"\n",(0,i.jsx)(n.admonition,{type:"caution",children:(0,i.jsx)(n.p,{children:"Push replicator will ignore this filter."})}),"\n",(0,i.jsx)(n.h3,{id:"documents",children:"Documents"}),"\n",(0,i.jsxs)(n.p,{children:["By default, Couchbase Lite will replicate all documents that belong to the channels specified in the collection configuration.  However, you can override this behavior by ",(0,i.jsx)(n.code,{children:"filtering"}),"  the documents using the ",(0,i.jsx)(n.code,{children:"CollectionConfiguration"})," object."]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-typescript",children:"const config = new ReplicatorConfiguration(target);\nconst collectionConfig = new CollectionConfiguration();\ncollectionConfig.setDocumentIDs(['doc1', 'doc2', 'doc3']);\nconfig.addCollection(collection, collectionConfig);\n"})}),"\n",(0,i.jsx)(n.h3,{id:"auto-purge-on-channel-access-revocation",children:"Auto-purge on Channel Access Revocation"}),"\n",(0,i.jsx)(n.admonition,{type:"caution",children:(0,i.jsx)(n.p,{children:"This is a Breaking Change at 3.0"})}),"\n",(0,i.jsx)(n.h4,{id:"new-outcome",children:"New outcome"}),"\n",(0,i.jsx)(n.p,{children:"By default, when a user loses access to a channel all documents in the channel (that do not also belong to any of the user\u2019s other channels) are auto-purged from the local database (in devices belonging to the user)."}),"\n",(0,i.jsx)(n.h4,{id:"prior-outcome",children:"Prior outcome"}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)(n.em,{children:"Previously these documents remained in the local database"})}),"\n",(0,i.jsx)(n.p,{children:"Prior to this release, CBL auto-purged only in the case when the user loses access to a document by removing the doc from all of the channels belong to the user. Now, in addition to 2.x auto purge, Couchbase Lite will also auto-purges the docs when the user loses access to the doc via channel access revocation. This feature is enabled by default, but an opt-out is available."}),"\n",(0,i.jsx)(n.h4,{id:"behaviour",children:"Behaviour"}),"\n",(0,i.jsx)(n.p,{children:"Users may lose access to channels in a number of ways:"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:"User loses direct access to channel"}),"\n",(0,i.jsx)(n.li,{children:"User is removed from a role"}),"\n",(0,i.jsx)(n.li,{children:"A channel is removed from a role the user is assigned to"}),"\n"]}),"\n",(0,i.jsxs)(n.p,{children:["By default, when a user loses access to a channel, the next Couchbase Lite Pull replication auto-purges all documents in the channel from local Couchbase Lite databases (on devices belonging to the user) unless they belong to any of the user\u2019s other channels\u2009\u2014\u2009see: ",(0,i.jsx)(n.a,{href:"#table-2-behavior-following-access-revocation",children:"Table 2"}),"."]}),"\n",(0,i.jsx)(n.p,{children:"Documents that exist in multiple channels belonging to the user (even if they are not actively replicating that channel) are not auto-purged unless the user loses access to all channels."}),"\n",(0,i.jsxs)(n.p,{children:["Users will be receive an ",(0,i.jsx)(n.code,{children:"AccessRemoved"})," notification from the DocumentListener if they lose document access due to channel access revocation; this is sent regardless of the current auto-purge setting."]}),"\n",(0,i.jsx)(n.h4,{id:"table-2-behavior-following-access-revocation",children:"Table 2. Behavior following access revocation"}),"\n",(0,i.jsxs)(n.table,{children:[(0,i.jsx)(n.thead,{children:(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.th,{}),(0,i.jsx)(n.th,{children:"System State"}),(0,i.jsx)(n.th,{children:"Impact on Sync"})]})}),(0,i.jsxs)(n.tbody,{children:[(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:(0,i.jsx)(n.strong,{children:"Replication Type"})}),(0,i.jsx)(n.td,{children:(0,i.jsx)(n.strong,{children:"Access Control on Sync Gateway"})}),(0,i.jsxs)(n.td,{children:[(0,i.jsx)(n.strong,{children:"Expected behavior when"})," ",(0,i.jsx)(n.em,{children:"enable_auto_purge=true"})]})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:(0,i.jsx)(n.strong,{children:"Pull only"})}),(0,i.jsx)(n.td,{children:"User revoked access to channel."}),(0,i.jsx)(n.td,{children:"Previously synced documents are auto purged on local"})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{}),(0,i.jsxs)(n.td,{children:["Sync Function includes ",(0,i.jsx)(n.code,{children:"requireAccess(revokedChannel)"})]}),(0,i.jsx)(n.td,{})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:(0,i.jsx)(n.strong,{children:"Push only"})}),(0,i.jsx)(n.td,{children:"User revoked access to channel."}),(0,i.jsx)(n.td,{children:"No impact of auto-purge"})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{}),(0,i.jsxs)(n.td,{children:["Sync Function includes ",(0,i.jsx)(n.code,{children:"requireAccess(revokedChannel)"})]}),(0,i.jsx)(n.td,{children:"Documents get pushed but are rejected by the server"})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:(0,i.jsx)(n.strong,{children:"Push-pull"})}),(0,i.jsx)(n.td,{children:"User revoked access to channel"}),(0,i.jsx)(n.td,{children:"Previously synced documents are auto purged on Couchbase Lite."})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{}),(0,i.jsxs)(n.td,{children:["Sync Function includes ",(0,i.jsx)(n.code,{children:"requireAccess(revokedChannel)"})]}),(0,i.jsx)(n.td,{children:"Local changes continue to be pushed to remote but are rejected by the server"})]})]})]}),"\n",(0,i.jsxs)(n.p,{children:["If a user subsequently regains access to a lost channel, then any previously auto-purged documents still assigned to any of their channels are automatically pulled down by the active server when they are next updated\u2009\u2014\u2009see behavior summary in ",(0,i.jsx)(n.a,{href:"#table-3-behavior-if-access-is-regained",children:"Table 3"}),"."]}),"\n",(0,i.jsx)(n.h4,{id:"table-3-behavior-if-access-is-regained",children:"Table 3. Behavior if access is regained"}),"\n",(0,i.jsxs)(n.table,{children:[(0,i.jsx)(n.thead,{children:(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.th,{}),(0,i.jsx)(n.th,{children:"System State"}),(0,i.jsx)(n.th,{children:"Impact on Sync"})]})}),(0,i.jsxs)(n.tbody,{children:[(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:(0,i.jsx)(n.strong,{children:"Replication Type"})}),(0,i.jsx)(n.td,{children:(0,i.jsx)(n.strong,{children:"Access Control on the Server"})}),(0,i.jsx)(n.td,{children:(0,i.jsx)(n.strong,{children:"Expected behavior when enable_auto_purge=true"})})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:(0,i.jsx)(n.strong,{children:"Pull only"})}),(0,i.jsx)(n.td,{children:"User REASSIGNED access to channel"}),(0,i.jsx)(n.td,{children:"Previously purged documents that are still in the channel are automatically pulled by Couchbase Lite when they are next updated"})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:(0,i.jsx)(n.strong,{children:"Push only"})}),(0,i.jsx)(n.td,{children:"User REASSIGNED access to channel"}),(0,i.jsx)(n.td,{children:"Local changes previously rejected by the serverwill not be automatically pushed to remote unless resetCheckpoint is involved on CBL. Document changes subsequent to the channel reassignment will be pushed up as usual."})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{}),(0,i.jsxs)(n.td,{children:["Sync Function includes ",(0,i.jsx)(n.code,{children:"requireAccess(reassignedChannel)"})," No impact of auto-purge"]}),(0,i.jsx)(n.td,{})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:(0,i.jsx)(n.strong,{children:"Push-pull"})}),(0,i.jsx)(n.td,{children:"User REASSIGNED access to channel"}),(0,i.jsx)(n.td,{children:"Previously purged documents are automatically pulled by Couchbase Lite"})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{}),(0,i.jsxs)(n.td,{children:["Sync Function includes ",(0,i.jsx)(n.code,{children:"requireAccess(reassignedChannel)"})]}),(0,i.jsx)(n.td,{children:"Local changes previously rejected by the server will not be automatically pushed to remote unless resetCheckpoint is involved. Document changes subsequent to the channel reassignment will be pushed up as usual."})]})]})]}),"\n",(0,i.jsx)(n.h4,{id:"config",children:"Config"}),"\n",(0,i.jsxs)(n.p,{children:["Auto-purge behavior is controlled primarily by the ReplicationConfiguration option ",(0,i.jsx)(n.code,{children:"enableAutoPurge"}),". Changing the state of this will impact only future replications; the replicator will not attempt to sync revisions that were auto purged on channel access removal. Clients wishing to sync previously removed documents must use the resetCheckpoint API to resync from the start."]}),"\n",(0,i.jsx)(n.h4,{id:"example-11-setting-auto-purge",children:"Example 11. Setting auto-purge"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-typescript",children:"// set auto-purge behavior (here we override default)\nconfig.enableAutoPurge = false;\n"})}),"\n",(0,i.jsx)(n.p,{children:"Here we have opted to turn off the auto purge behavior. By default auto purge is enabled."}),"\n",(0,i.jsx)(n.h3,{id:"delta-sync",children:"Delta Sync"}),"\n",(0,i.jsx)(n.admonition,{type:"important",children:(0,i.jsxs)(n.p,{children:["This is an ",(0,i.jsx)(n.a,{href:"https://www.couchbase.com/products/editions/",children:"Enterprise Edition"})," feature."]})}),"\n",(0,i.jsx)(n.p,{children:"With Delta Sync, only the changed parts of a Couchbase document are replicated. This can result in significant savings in bandwidth consumption as well as throughput improvements, especially when network bandwidth is typically constrained."}),"\n",(0,i.jsxs)(n.p,{children:["Replications to a Server (for example, a Sync Gateway, or passive listener) automatically use delta sync if the property is enabled at database level by the server\u2009\u2014\u2009see: ",(0,i.jsx)(n.a,{href:"https://docs.couchbase.com/sync-gateway/current/configuration-properties-legacy.html#databases-foo_db-delta_sync",children:"databases.$db.delta_sync.enabled"}),"."]}),"\n",(0,i.jsx)(n.p,{children:"Intra-Device replications automatically disable delta sync, whilst Peer-to-Peer replications automatically enable delta sync."}),"\n",(0,i.jsx)(n.h2,{id:"initialize",children:"Initialize"}),"\n",(0,i.jsx)(n.h5,{id:"in-this-section-1",children:"In this section"}),"\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.a,{href:"#start-replicator",children:"Start Replicator"})," | ",(0,i.jsx)(n.a,{href:"#checkpoint-starts",children:"Checkpoint Starts"})]}),"\n",(0,i.jsx)(n.h3,{id:"start-replicator",children:"Start Replicator"}),"\n",(0,i.jsxs)(n.p,{children:["Use the ",(0,i.jsx)(n.code,{children:"Replicator.create()"})," method to initialize the replicator with the configuration you have defined. You can optionally add a change listener (see ",(0,i.jsx)(n.a,{href:"#monitor",children:"Monitor"}),") before starting the replicator using ",(0,i.jsx)(n.code,{children:"start()"}),"."]}),"\n",(0,i.jsx)(n.h4,{id:"example-12-initialize-and-run-replicator",children:"Example 12. Initialize and run replicator"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-typescript",children:"// Apply configuration settings to the replicator\nconst replicator = await Replicator.create(config);\n\n// start the replicator without making a new checkpoint\nawait replicator.start(false);\n"})}),"\n",(0,i.jsx)(n.h3,{id:"checkpoint-starts",children:"Checkpoint Starts"}),"\n",(0,i.jsxs)(n.p,{children:["Replicators use ",(0,i.jsx)(n.code,{children:"checkpoints"})," to keep track of documents sent to the target database."]}),"\n",(0,i.jsxs)(n.p,{children:["Without ",(0,i.jsx)(n.code,{children:"checkpoints"}),", Couchbase Lite would replicate the entire database content to the target database on each connection, even though previous replications may already have replicated some or all of that content."]}),"\n",(0,i.jsxs)(n.p,{children:["This functionality is generally not a concern to application developers. However, if you do want to force the replication to start again from zero, use the ",(0,i.jsx)(n.code,{children:"checkpoint"})," reset argument when starting the replicator\u2009\u2014\u2009as shown in Example 13."]}),"\n",(0,i.jsx)(n.h4,{id:"example-13-resetting-checkpoints",children:"Example 13. Resetting checkpoints"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-typescript",children:"if (doResetCheckpointRequired) {\n    this.replicator.start(true);\n} else {\n    this.replicator.start(false);\n}\n"})}),"\n",(0,i.jsxs)(n.p,{children:["The default ",(0,i.jsx)(n.code,{children:"false"})," is shown here for completeness only; it is unlikely you would explicitly use it in practice."]}),"\n",(0,i.jsx)(n.h2,{id:"monitor",children:"Monitor"}),"\n",(0,i.jsx)(n.h5,{id:"in-this-section-2",children:"In this section"}),"\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.a,{href:"#change-listeners",children:"Change Listeners"})," | ",(0,i.jsx)(n.a,{href:"#replicator-status",children:"Replicator Status"})," | ",(0,i.jsx)(n.a,{href:"#monitor-document-changes",children:"Monitor Document Changes"})," | ",(0,i.jsx)(n.a,{href:"#documents-pending-push",children:"Documents Pending Push"})]}),"\n",(0,i.jsxs)(n.p,{children:["You can monitor a replication\u2019s status by using a combination of ",(0,i.jsx)(n.code,{children:"Change Listeners"})," and the ",(0,i.jsx)(n.code,{children:"Replicator.getStatus()"})," property. This enables you to know, for example, when the replication is actively transferring data and when it has stopped."]}),"\n",(0,i.jsxs)(n.p,{children:["You can also choose to monitor document changes\u2009\u2014\u2009see: ",(0,i.jsx)(n.a,{href:"#monitor-document-changes",children:"Monitor Document Changes"}),"."]}),"\n",(0,i.jsx)(n.h3,{id:"change-listeners",children:"Change Listeners"}),"\n",(0,i.jsx)(n.p,{children:"Use this to monitor changes and to inform on sync progress; this is an optional step. You can add and a replicator change listener at any point; it will report changes from the point it is registered."}),"\n",(0,i.jsx)(n.admonition,{type:"tip",children:(0,i.jsx)(n.p,{children:"Don\u2019t forget to save the token so you can remove the listener later"})}),"\n",(0,i.jsxs)(n.p,{children:["Use the ",(0,i.jsx)(n.code,{children:"Replicator"})," class to add a change listener as a callback to the Replicator (",(0,i.jsx)(n.code,{children:"addChangeListener()"}),")\u2009\u2014\u2009see: ",(0,i.jsx)(n.a,{href:"#example-14-monitor-replication",children:"Example 14"}),". You will then be asynchronously notified of state changes."]}),"\n",(0,i.jsxs)(n.p,{children:["You can remove a change listener with ",(0,i.jsx)(n.code,{children:"removeChangeListener(token)"}),"."]}),"\n",(0,i.jsx)(n.h3,{id:"replicator-status",children:"Replicator Status"}),"\n",(0,i.jsxs)(n.p,{children:["You can use the ",(0,i.jsx)(n.code,{children:"Replicator.getStatus()"})," property to check the replicator status. That is, whether it is actively transferring data or if it has stopped\u2009\u2014\u2009see: ",(0,i.jsx)(n.a,{href:"#example-14-monitor-replication",children:"Example 14"}),"."]}),"\n",(0,i.jsxs)(n.p,{children:["The returned ",(0,i.jsx)(n.em,{children:"ReplicationStatus"})," structure comprises:"]}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.code,{children:"ActivityLevel"}),"\u2009\u2014\u2009stopped, offline, connecting, idle or busy\u2009\u2014\u2009see states described in: ",(0,i.jsx)(n.a,{href:"#table-5-replicator-activity-levels",children:"Table 5"})]}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsx)(n.p,{children:(0,i.jsx)(n.code,{children:"Progress"})}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:"completed\u2009\u2014\u2009the total number of changes completed"}),"\n",(0,i.jsx)(n.li,{children:"total\u2009\u2014\u2009the total number of changes to be processed"}),"\n"]}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.code,{children:"Error"})," - the current error, if any."]}),"\n"]}),"\n"]}),"\n",(0,i.jsx)(n.h4,{id:"example-14-monitor-replication",children:"Example 14. Monitor replication"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-typescript",children:"// Optionally add a change listener\n// Retain token for use in deletion\nconst token = replicator.addChangeListener((change) => {\n    if (change.status.getActivityLevel() === 'STOPPED') {\n        console.log(\"Replication stopped\");\n    } else {\n        console.log(`Replicator is currently : ${change.status.getActivityLevel()}`);\n    }\n});\n"})}),"\n",(0,i.jsx)(n.h3,{id:"replication-states",children:"Replication States"}),"\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.a,{href:"#table-5-replicator-activity-levels",children:"Table 5"})," shows the different states, or activity levels, reported in the API; and the meaning of each."]}),"\n",(0,i.jsx)(n.h4,{id:"table-5-replicator-activity-levels",children:"Table 5. Replicator activity levels"}),"\n",(0,i.jsxs)(n.table,{children:[(0,i.jsx)(n.thead,{children:(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.th,{children:(0,i.jsx)(n.strong,{children:"State"})}),(0,i.jsx)(n.th,{children:(0,i.jsx)(n.strong,{children:"Meaning"})})]})}),(0,i.jsxs)(n.tbody,{children:[(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"STOPPED"})}),(0,i.jsx)(n.td,{children:"The replication is finished or hit a fatal error."})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"OFFLINE"})}),(0,i.jsx)(n.td,{children:"The replicator is offline as the remote host is unreachable"})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"CONNECTING"})}),(0,i.jsx)(n.td,{children:"The replicator is connecting to the remote host"})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"IDLE"})}),(0,i.jsxs)(n.td,{children:["The replication caught up with all the changes available from the server. The ",(0,i.jsx)(n.code,{children:"IDLE"})," state is only used in continuous replications."]})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"BUSY"})}),(0,i.jsx)(n.td,{children:"The replication is actively transferring data."})]})]})]}),"\n",(0,i.jsx)(n.h3,{id:"replication-status-and-app-life-cycle",children:"Replication Status and App Life Cycle"}),"\n",(0,i.jsx)(n.p,{children:"The following diagram describes the status changes when the application starts a replication, and when the application is being backgrounded or foregrounded by the OS. It applies to iOS only."}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)(n.img,{alt:"Replicator States",src:t(4697).A+"",width:"1934",height:"914"})}),"\n",(0,i.jsxs)(n.p,{children:["Additionally, on iOS, an app already in the background may be terminated. In this case, the ",(0,i.jsx)(n.code,{children:"Database"})," and ",(0,i.jsx)(n.code,{children:"Replicator"})," instances will be ",(0,i.jsx)(n.code,{children:"null"})," when the app returns to the foreground. Therefore, as preventive measure, it is recommended to do a ",(0,i.jsx)(n.code,{children:"null"})," check when the app enters the foreground, and to re-initialize the database and replicator if any of those is ",(0,i.jsx)(n.code,{children:"null"}),"."]}),"\n",(0,i.jsx)(n.p,{children:"On other platforms, Couchbase Lite doesn\u2019t react to OS backgrounding or foregrounding events and replication(s) will continue running as long as the remote system does not terminate the connection and the app does not terminate. It is generally recommended to stop replications before going into the background otherwise socket connections may be closed by the OS and this may interfere with the replication process."}),"\n",(0,i.jsx)(n.h3,{id:"monitor-document-changes",children:"Monitor Document Changes"}),"\n",(0,i.jsx)(n.p,{children:"You can choose to register for document updates during a replication."}),"\n",(0,i.jsxs)(n.p,{children:["For example, the code snippet in ",(0,i.jsx)(n.a,{href:"#example-15-register-a-document-listener",children:"Example 15"})," registers a listener to monitor document replication performed by the replicator referenced by the variable ",(0,i.jsx)(n.code,{children:"replicator"}),". It prints the document ID of each document received and sent. Stop the listener as shown in ",(0,i.jsx)(n.a,{href:"#example-16-stop-document-listener",children:"Example 16"}),"."]}),"\n",(0,i.jsx)(n.h4,{id:"example-15-register-a-document-listener",children:"Example 15. Register a document listener"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-typescript",children:'const token = await replicator.addDocumentChangeListener((replication) => {\n    console.log(`Replication type :: ${replication.isPush ? "Push" : "Pull"}`);\n    for (const document of replication.documents) {\n        if (document.error === undefined) {\n            console.log(`Doc ID :: ${document.id}`);\n            if (document.flags.includes(\'DELETED\')) {\n                console.log("Successfully replicated a deleted document");\n            }\n        } else {\n            console.error("Error replicating document:", document.error);\n        }\n    }\n});\n\n// Start the replicator without resetting the checkpoint\nawait replicator.start(false);\n'})}),"\n",(0,i.jsx)(n.h4,{id:"example-16-stop-document-listener",children:"Example 16. Stop document listener"}),"\n",(0,i.jsx)(n.p,{children:"This code snippet shows how to stop the document listener using the token from the previous example."}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-typescript",children:"await this.replicator.removeChangeListener(token);\n"})}),"\n",(0,i.jsx)(n.h3,{id:"document-access-removal-behavior",children:"Document Access Removal Behavior"}),"\n",(0,i.jsxs)(n.p,{children:["When access to a document is removed on a server (see: Sync Gateway\u2019s ",(0,i.jsx)(n.a,{href:"https://docs.couchbase.com/sync-gateway/current/sync-function-api.html",children:"Sync Function"}),"), the document replication listener sends a notification with the ",(0,i.jsx)(n.code,{children:"AccessRemoved"})," flag set to ",(0,i.jsx)(n.code,{children:"true"})," and subsequently purges the document from the database."]}),"\n",(0,i.jsx)(n.h2,{id:"documents-pending-push",children:"Documents Pending Push"}),"\n",(0,i.jsx)(n.admonition,{type:"tip",children:(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.code,{children:"Replicator.isDocumentPending()"})," is quicker and more efficient. Use it in preference to returning a list of pending document IDs, where possible."]})}),"\n",(0,i.jsx)(n.p,{children:"You can check whether documents are waiting to be pushed in any forthcoming sync by using either of the following API methods:"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:["Use the ",(0,i.jsx)(n.code,{children:"Replicator.pendingDocumentIds()"})," method, which returns a list of document IDs that have local changes, but which have not yet been pushed to the server."]}),"\n",(0,i.jsxs)(n.li,{children:["Use the ",(0,i.jsx)(n.code,{children:"Replicator.isDocumentPending()"})," method to quickly check whether an individual document is pending a push."]}),"\n"]}),"\n",(0,i.jsx)(n.h4,{id:"example-17-use-pending-document-id-api",children:"Example 17. Use Pending Document ID API"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-typescript",children:"// Todo \n"})}),"\n",(0,i.jsx)(n.h2,{id:"stop",children:"Stop"}),"\n",(0,i.jsxs)(n.p,{children:["Stopping a replication is straightforward. It is done using ",(0,i.jsx)(n.code,{children:"stop()"}),". This initiates an asynchronous operation and so is not necessarily immediate. Your app should account for this potential delay before attempting any subsequent operations."]}),"\n",(0,i.jsxs)(n.p,{children:["You can find further information on database operations in ",(0,i.jsx)(n.a,{href:"/databases",children:"Databases"}),"."]}),"\n",(0,i.jsx)(n.h4,{id:"example-18-stop-replicator",children:"Example 18. Stop replicator"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-typescript",children:"// Remove the change listener\nawait this.replicator.removeChangeListener(token)\n\n// Stop the replicator\nawait this.replicator.stop()\n"})}),"\n",(0,i.jsxs)(n.p,{children:["Here we initiate the stopping of the replication using the ",(0,i.jsx)(n.code,{children:"stop()"})," method. It will stop any active ",(0,i.jsx)(n.code,{children:"change listener"})," once the replication is stopped."]}),"\n",(0,i.jsx)(n.h2,{id:"error-handling",children:"Error Handling"}),"\n",(0,i.jsxs)(n.p,{children:["When ",(0,i.jsx)(n.em,{children:"replicator"})," detects a network error it updates its status depending on the error type (permanent or temporary) and returns an appropriate HTTP error code."]}),"\n",(0,i.jsxs)(n.p,{children:["The following code snippet adds a ",(0,i.jsx)(n.code,{children:"Change Listener"}),", which monitors a replication for errors and logs the the returned error code."]}),"\n",(0,i.jsx)(n.h4,{id:"example-19-monitoring-for-network-errors",children:"Example 19. Monitoring for network errors"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-typescript",children:"replicator.addChangeListener((change) => {\n    const error = change.status.getError();\n    if (error) {\n        console.log(`Error code :: ${error.code}`);\n    }\n});\n"})}),"\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.strong,{children:"For permanent network errors"})," (for example, ",(0,i.jsx)(n.code,{children:"404"})," not found, or ",(0,i.jsx)(n.code,{children:"401"})," unauthorized): ",(0,i.jsx)(n.em,{children:"Replicator"})," will stop permanently, whether ",(0,i.jsx)(n.code,{children:"setContinuous"})," is ",(0,i.jsx)(n.em,{children:"true"})," or ",(0,i.jsx)(n.em,{children:"false"}),". Of course, it sets its status to ",(0,i.jsx)(n.code,{children:"STOPPED"})]}),"\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.strong,{children:"For recoverable or temporary errors:"})," ",(0,i.jsx)(n.em,{children:"Replicator"})," sets its status to ",(0,i.jsx)(n.code,{children:"OFFLINE"}),", then:"]}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:["If ",(0,i.jsx)(n.code,{children:"setContinuous=true"})," it retries the connection indefinitely"]}),"\n",(0,i.jsxs)(n.li,{children:["If ",(0,i.jsx)(n.code,{children:"setContinuous=false"})," (one-shot) it retries the connection a limited number of times."]}),"\n"]}),"\n",(0,i.jsx)(n.p,{children:"The following error codes are considered temporary by the Couchbase Lite replicator and thus will trigger a connection retry."}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"408"}),": Request Timeout"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"429"}),": Too Many Requests"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"500"}),": Internal Server Error"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"502"}),": Bad Gateway"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"503"}),": Service Unavailable"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"504"}),": Gateway Timeout"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"1001"}),": DNS resolution error"]}),"\n"]}),"\n",(0,i.jsx)(n.h2,{id:"load-balancers",children:"Load Balancers"}),"\n",(0,i.jsxs)(n.p,{children:["Couchbase Lite uses WebSockets as the communication protocol to transmit data. Some load balancers are not configured for WebSocket connections by default (NGINX for example); so it might be necessary to explicitly enable them in the load balancer\u2019s configuration (see ",(0,i.jsx)(n.a,{href:"https://docs.couchbase.com/sync-gateway/current/load-balancer.html",children:"Load Balancers"}),")."]}),"\n",(0,i.jsxs)(n.p,{children:["By default, the WebSocket protocol uses compression to optimize for speed and bandwidth utilization. The level of compression is set on Sync Gateway and can be tuned in the configuration file (",(0,i.jsx)(n.a,{href:"https://docs.couchbase.com/sync-gateway/current/configuration-properties-legacy.html#replicator_compression",children:"replicator_compression"}),")."]}),"\n",(0,i.jsx)(n.h2,{id:"troubleshooting",children:"Troubleshooting"}),"\n",(0,i.jsx)(n.h3,{id:"logs",children:"Logs"}),"\n",(0,i.jsxs)(n.p,{children:["As always, when there is a problem with replication, logging is your friend. You can increase the log output for activity related to replication with Sync Gateway\u2009\u2014\u2009see ",(0,i.jsx)(n.a,{href:"#example-21-set-logging-verbosity",children:"Example 21"}),"."]}),"\n",(0,i.jsx)(n.h4,{id:"example-21-set-logging-verbosity",children:"Example 21. Set logging verbosity"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-typescript",children:"// Verbose / Replicator\ndatabase.setLogLevel(LogDomain.REPLICATOR, Loglevel.VERBOSE);\n\n// Verbose / Network\ndatabase.setLogLevel(LogDomain.NETWORK, Loglevel.VERBOSE);\n"})}),"\n",(0,i.jsxs)(n.p,{children:["For more on troubleshooting with logs, see: ",(0,i.jsx)(n.a,{href:"/Troubleshooting/using-logs",children:"Using Logs"}),"."]}),"\n",(0,i.jsx)(n.h3,{id:"authentication-errors",children:"Authentication Errors"}),"\n",(0,i.jsxs)(n.p,{children:["If Sync Gateway is configured with a self signed certificate but your app points to a ",(0,i.jsx)(n.code,{children:"ws"})," scheme instead of ",(0,i.jsx)(n.code,{children:"wss"})," you will encounter an error with status code 11006\u2009\u2014\u2009see: ",(0,i.jsx)(n.a,{href:"#example-22-protocol-mismatch",children:"Example 22"})]}),"\n",(0,i.jsx)(n.h4,{id:"example-22-protocol-mismatch",children:"Example 22. Protocol Mismatch"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-console",children:'CouchbaseLite Replicator ERROR: {Repl#2} Got LiteCore error: WebSocket error 1006 "connection closed abnormally"\n'})}),"\n",(0,i.jsxs)(n.p,{children:["If Sync Gateway is configured with a self signed certificate, and your app points to a ",(0,i.jsx)(n.code,{children:"wss"})," scheme but the replicator configuration isn\u2019t using the certificate you will encounter an error with status code ",(0,i.jsx)(n.code,{children:"5011"}),"\u2009\u2014\u2009see: ",(0,i.jsx)(n.a,{href:"#example-23-certificate-mismatch-or-not-found",children:"Example 23"})]}),"\n",(0,i.jsx)(n.h4,{id:"example-23-certificate-mismatch-or-not-found",children:"Example 23. Certificate Mismatch or Not Found"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-console",children:'CouchbaseLite Replicator ERROR: {Repl#2} Got LiteCore error: Network error 11 "server TLS certificate is self-signed or has unknown root cert"\n'})})]})}function h(e={}){const{wrapper:n}={...(0,s.R)(),...e.components};return n?(0,i.jsx)(n,{...e,children:(0,i.jsx)(d,{...e})}):d(e)}},7943:(e,n,t)=>{t.d(n,{A:()=>i});const i=t.p+"assets/images/cbl-replication-scopes-collections-1-0d0f78f1482260e9798165e302a25a79.png"},7308:(e,n,t)=>{t.d(n,{A:()=>i});const i=t.p+"assets/images/cbl-replication-scopes-collections-2-0fe3c8d39a7e607ffc343de2337b5dbe.png"},6725:(e,n,t)=>{t.d(n,{A:()=>i});const i=t.p+"assets/images/cbl-replication-scopes-collections-3-f7f78a091e8ffbd50c5bdbf57b70085b.png"},2058:(e,n,t)=>{t.d(n,{A:()=>i});const i=t.p+"assets/images/cbl-replication-scopes-collections-4-1b030ec159be9f916e2efc746bea9ca1.png"},4697:(e,n,t)=>{t.d(n,{A:()=>i});const i=t.p+"assets/images/replicator-states-131cd1d916435293b2ad2c7049ceb4d9.png"},8453:(e,n,t)=>{t.d(n,{R:()=>a,x:()=>r});var i=t(6540);const s={},o=i.createContext(s);function a(e){const n=i.useContext(o);return i.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function r(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(s):e.components||s:a(e.components),i.createElement(o.Provider,{value:n},e.children)}}}]);